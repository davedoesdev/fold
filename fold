#!/bin/bash
set -e

BRIDGE=weave
TAP_IFNAME=vethfotp$$
MTU=16384 # max TAP MTU
NFDHCP_BINDING_OUT="/var/lib/nfdhcpd/$TAP_IFNAME"

usage() {
    echo "Usage:"
    echo "fold [-4 <ipaddr>/<subnet>] [-6 <ip6prefix>] [-c <nfdhcp-binding-file> <macaddr> kvm [<kvm args> ...]"
    exit 1
}

[ "$(id -u)" = 0 ] || {
    echo "fold must be run as 'root'" >&2
    exit 1
}

while getopts 4:6:c: opt
do
    case $opt in
        4)
            IPSUB="$OPTARG"
            ;;
        6)
            PREFIX="$OPTARG"
            ;;
        c)
            NFDHCP_BINDING_IN="$OPTARG"
            ;;
        *)
            usage
            ;;
    esac
done

shift $((OPTIND-1))

[ $# -gt 1 ] || usage

MACADDR="$1"
COMMAND="$2"
shift 2

if [ "$IPSUB" ]
then
    # extract the IP address from an ipaddr/subnet spec
    IFS=/ read -a ipsub <<< "$IPSUB"
    IPADDR="${ipsub[0]}"

    # make a zero-ending subnet mask (CIDR) from an ipaddr/subnet spec
    IFS=. read -a ipaddr <<< "$IPADDR"
    ipnum=$(((ipaddr[0] << 24) + (ipaddr[1] << 16) + (ipaddr[2] << 8) + (ipaddr[3])))
    ipnum=$((ipnum & ~(2 ** (32 - ipsub[1]) - 1)))
    SUBNET=$((ipnum >> 24 & 255)).$((ipnum >> 16 & 255)).$((ipnum >> 8 & 255)).$((ipnum & 255))/${ipsub[1]}
fi

untap() {
    if ip link show dev "$TAP_IFNAME" >& /dev/null; then
         ip link del dev "$TAP_IFNAME"
    fi
}

tap() {
    ip tuntap add dev "$TAP_IFNAME" mode tap
    ip link set dev "$TAP_IFNAME" master "$BRIDGE"
    ip link set dev "$TAP_IFNAME" up
}

cleanup() {
    untap
    rm -f "$NFDHCP_BINDING_OUT"    
}

trap cleanup EXIT

untap; tap

if [ "$NFDHCP_BINDING_IN" ]; then
    ( echo "MAC=$MACADDR"
      [ "$IPADDR" ] && echo "IP=$IPADDR"
      [ "$SUBNET" ] && echo "SUBNET=$SUBNET"
      [ "$PREFIX" ] && echo "SUBNET6=$PREFIX"
      cat "$NFDHCP_BINDING_IN" )  > "$NFDHCP_BINDING_OUT"
fi

case "$COMMAND" in
    kvm)

# can we ping link local addresses? find out if switch should route them - as weave is an ethernet switch it probably shouldn't. even if we could, it means we couldn't restrict traffic based on prefix. so we should check we CAN'T ping local link addresses
# neighbour solicitation address - do we need FORWARD and mangle rules for other direction? otherwise won't get through

        # setup packet filtering rules; can we group them to make removing easier?


        # run kvm
        # kvm -netdev bridge,id=hn0,br=weave -device virtio-net-pci,netdev=hn0,id=nic1,mac=52:54:00:12:34:56 -hda disk.qcow2 
        # use -netdev tap

        # then need to remove the rules

        ;;
    *)
        echo "Unknown fold command '$COMMAND'" >&2
        usage
        ;;
esac

